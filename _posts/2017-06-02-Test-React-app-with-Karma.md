---
layout: post
title: "Test React app with Karma"
category: Javascript
tags: [Karma, React]
date: 2017-06-02
---

### Why Karma?###

![karma-logo](http://karma-runner.github.io/assets/img/banner.png)

å‰ç«¯çš„å·¥å…·çœŸçš„å¤ªå¤šäº†ï¼Œå¤šçš„æœ‰ç‚¹è®©äººçœ¼èŠ±ç¼­ä¹±ã€‚é—®é¢˜æ˜¯æˆ‘ä»¬çœŸçš„éœ€è¦è¿™ä¹ˆå¤šçš„å·¥å…·å—ï¼Ÿæˆ‘è§‰å¾—å¯¹äºä¸€ä¸ªæˆç†Ÿçš„éœ€è¦é•¿æœŸæ›´æ–°ç»´æŠ¤çš„ä»£ç åº“è€Œè¨€ï¼Œæ˜¯çš„ï¼ŒçœŸçš„éœ€è¦ğŸ˜‚ï¼Œæœ€èµ·ç æ¯ä¸€ç±»å·¥å…·æ€»å¾—éœ€è¦é€‰æ‹©ä¸€ä¸ªæ¥ä½¿ç”¨ã€‚è€Œå¯¹äºé‚£äº›â€œä¸€æ¬¡æ€§â€çš„ä½œå“ï¼Œæˆ‘è§‰å¾—å¾ˆå¤šå·¥å…·å¤§å¯çœç•¥ä¸ç”¨ï¼ˆå®ƒä»¬ç”šè‡³è¿æµ‹è¯•ä»£ç éƒ½å¯ä»¥ä¸éœ€è¦ï¼‰ã€‚è€Œ[Karma](http://karma-runner.github.io/)å°±æ˜¯å±äºé‚£ä¸€ç±»å¯ç”¨å¯ä¸ç”¨çš„å·¥å…·ã€‚è¿™ç±»å¯ç”¨å¯ä¸ç”¨çš„å·¥å…·æœ‰ä¸€äº›å…±æ€§ï¼Œå®ƒä»¬è¦ä¹ˆæ˜¯ä¸ºäº†è§£å†³å› é¡¹ç›®å¤æ‚åº¦æé«˜è€Œäº§ç”Ÿçš„é—®é¢˜ï¼ˆå°é¡¹ç›®å¯ä»¥ä¸ç”¨ï¼‰ï¼Œè¦ä¹ˆæ˜¯ä¸ºäº†æé«˜å¼€å‘çš„æ•ˆç‡ï¼ˆä¸é‚£ä¹ˆå…³å¿ƒæ•ˆç‡çš„è¯å¯ä»¥ä¸ç”¨ï¼‰ã€‚

[Karma](http://karma-runner.github.io/)æ­£æ˜¯ä¸ºæ•ˆç‡è€Œç”Ÿã€‚

æˆ‘ä»¬å…ˆå›å¿†ä¸‹ç°åœ¨å¤§éƒ¨åˆ†çš„åç«¯æµ‹è¯•æµç¨‹ï¼Œåº”è¯¥æ˜¯åƒä¸‹é¢è¿™æ ·ï¼š

```
ä»£ç æ”¹åŠ¨ => æ‰§è¡Œæµ‹è¯• ==Pass=> å‘å¸ƒ
   ^          |
   |==Fail====|
```

å…·ä½“ä»£ç æ”¹åŠ¨å¤šå°‘æ¥æ‰§è¡Œä¸€æ¬¡æµ‹è¯•åˆ™å„ä¸ªé¡¹ç›®éƒ½æœ‰æ‰€ä¸åŒäº†ã€‚ä¸€ä¸ªæ¯”è¾ƒæ™®éçš„åšæ³•æ˜¯ï¼Œåœ¨äº§å“å‘å¸ƒè¾ƒå¤§çš„ç‰ˆæœ¬å˜æ›´ä¹‹å‰ï¼Œæ‰§è¡Œä¸€åˆ°ä¸¤æ¬¡full regression testï¼ˆä¹Ÿå°±æ˜¯æ‰€æœ‰æµ‹è¯•éƒ½è¦æ‰§è¡Œï¼‰ï¼›åœ¨ä»£ç è¦åˆå¹¶ï¼ˆæˆ–æäº¤ï¼‰åˆ°ä¸»è¦çš„ä»£ç åˆ†æ”¯ä¸Šæ—¶ï¼Œæ‰§è¡Œsmoke testï¼ˆå½“ç„¶å¦‚æœfull regression testè€—æ—¶çŸ­çš„è¯ï¼Œä¹Ÿå¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œfull regressionï¼‰ï¼ˆè¿™é‡Œé€šå¸¸æ˜¯å’ŒCIé›†æˆåœ¨ä¸€èµ·çš„ï¼Œä¸éœ€è¦æ‰‹åŠ¨å»æ‰§è¡Œæµ‹è¯•ï¼‰ã€‚

å‰ç«¯çš„æµ‹è¯•æµç¨‹å…¶å®å’Œåç«¯æ˜¯ç±»ä¼¼çš„ï¼Œå®ƒä»¬çš„ä¸»è¦çš„åŒºåˆ«åœ¨äºï¼š

- åç«¯çš„æµ‹è¯•ä»£ç å¾€å¾€æ‰§è¡Œæ—¶é—´è¦è¿œå¤šäºå‰ç«¯çš„æµ‹è¯•ä»£ç ï¼›
- ä¸€äº›åç«¯çš„å¼€å‘ä»£ç ç¼–è¯‘è€—æ—¶è¿œå¤§äºå‰ç«¯ä»£ç ï¼›

è¿™ä¹Ÿå¯¼è‡´äº†åç«¯çš„æµ‹è¯•çš„é¢‘åº¦ä¸ä¼šå¤ªé«˜ã€‚æƒ³è±¡ä¸€ä¸‹ï¼ŒæŸä¸€ä¸ªåç«¯çš„é¡¹ç›®ç¼–è¯‘å°±éœ€è¦åŠä¸ªå°æ—¶ï¼Œæµ‹è¯•ä»£ç æ‰§è¡Œå†èŠ±ä¸ªåŠä¸ªå°æ—¶ï¼Œå¦‚æœæˆ‘ä»…ä»…æ˜¯ä¿®æ”¹äº†æŸä¸ªå‡½æ•°ä¸­çš„æŸè¡Œä»£ç ï¼Œæˆ‘ä¼šæ„¿æ„å»èŠ±è¿™ä¸€ä¸ªå°æ—¶æ¥æµ‹è¯•ä¸‹æ˜¯å¦æˆ‘çš„è¿™ä¸ªä¿®æ”¹äº§ç”Ÿäº†bugå—ï¼Ÿå³ä½¿æ¯ä¸€æ¬¡ä»£ç ä¿®æ”¹éƒ½è¿™æ ·åšäº†ï¼Œè™½ç„¶ä¿è¯äº†ä»£ç è´¨é‡ï¼Œä½†æ•ˆç‡å¾—å¤šä½å•Šã€‚

è€Œå‰ç«¯æµ‹è¯•å°±æ²¡æœ‰ä¸Šé¢çš„è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºæˆ‘çš„ç¼–è¯‘åŠ ä¸Šæµ‹è¯•å¯èƒ½æ€»å…±ä¹Ÿå°±1åˆ†é’Ÿï¼Œå®Œå…¨å¯ä»¥åšåˆ°æ¯ä¸€æ¬¡æäº¤ä»£ç éƒ½æ‰§è¡Œä¸€éæµ‹è¯•ã€‚è€Œ[Karma](http://karma-runner.github.io/)åˆ™å¯ä»¥å°†æµ‹è¯•çš„ç²’åº¦è¿›ä¸€æ­¥ç»†åŒ–ï¼šæ¯ä¸€æ¬¡æœ‰æ–‡ä»¶ä¿®æ”¹éƒ½æ‰§è¡Œä¸€éæµ‹è¯•ï¼è¿™æ ·å¸¦æ¥çš„ç›´æ¥çš„å¥½å¤„æ˜¯ï¼šåŸå…ˆæäº¤äº†ä»£ç æ‰èƒ½å‘ç°çš„bugç°åœ¨å¯ä»¥ç«‹é©¬å°±å‘ç°äº†ï¼Œçœå»äº†å®šä½bugçš„æ—¶é—´ã€‚æ‰€ä»¥æˆ‘è¯´[Karma](http://karma-runner.github.io/)æ˜¯æé«˜æ•ˆç‡çš„å·¥å…·ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œè¿™ç§ä»¥æ–‡ä»¶ä¿®æ”¹æ¥æ‰§è¡Œæµ‹è¯•çš„ç²’åº¦è¿˜æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå®ƒè®©TDD (Test Driven Develop) å˜å¾—éå¸¸å®¹æ˜“ï¼Œä½ å®Œå…¨å¯ä»¥å…ˆæŠŠæµ‹è¯•ä»£ç å†™å¥½ï¼Œå†æ¥å†™å¼€å‘ä»£ç ï¼Œç›´åˆ°å¼€å‘ä»£ç å¯ä»¥æ»¡è¶³æ‰€æœ‰çš„æµ‹è¯•ä»£ç éƒ½é€šè¿‡ä¸ºæ­¢ã€‚

å¦å¤–ï¼Œ[Karma](http://karma-runner.github.io/)æ˜¯å°†æµ‹è¯•çš„ä»£ç æ”¾å…¥çœŸå®çš„æµè§ˆå™¨ä¸­å»æ‰§è¡Œçš„ï¼Œå³åŒæ—¶æµ‹è¯•äº†ç”Ÿäº§ç¯å¢ƒä¾èµ–å’Œå…¼å®¹æ€§ã€‚

ä»¥ä¸Šï¼Œ**[Karma](http://karma-runner.github.io/)æ˜¯ä¸€ç§Test Runnerå·¥å…·ï¼Œå®ƒå¯ä»¥è®©æµ‹è¯•åœ¨ä»£ç å‘ç”Ÿå¾ˆå°‘çš„å˜åŠ¨åå°±æ‰§è¡Œï¼Œä»è€Œåœ¨ä¿è¯å¼€å‘è´¨é‡çš„åŸºç¡€ä¸Šæé«˜äº†å¼€å‘çš„æ•ˆç‡ã€‚**ï¼ˆå¦‚æœè¦å’Œåç«¯ç±»æ¯”çš„è¯ï¼Œå®ƒæœ‰ç‚¹åƒæ˜¯Jenkinsçš„è§’è‰²ï¼‰

### Test a React app###

ç°åœ¨ï¼Œå‡å¦‚æˆ‘ç°åœ¨æƒ³å†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•å‡½æ•°ï¼Œå°±æµ‹ä¸€ä¸‹æˆ‘ä¸€ä¸ªå·²ç»å®ç°äº†çš„React appï¼ˆç”±`create-react-app`ç”Ÿæˆï¼‰èƒ½å¦æˆåŠŸåŠ è½½åˆ°é¡µé¢ä¸Šã€‚ä¸€ä¸ªç®€å•ç›´æ¥çš„æƒ³æ³•æ˜¯ç›´æ¥åœ¨æµ‹è¯•çš„ä»£ç ä¸­importåŒ…å«React appæ¸²æŸ“çš„é‚£ä¸ªjsæ–‡ä»¶ä¸å°±å¥½äº†ï¼Ÿç„¶è€Œï¼Œè¿™æ ·åšä¼šå‘ç°å¦‚ä¸‹é”™è¯¯ï¼š

```
Invariant Violation: _registerComponent(...): Target container is not a DOM element.
```

ç®€å•è¯´å°±æ˜¯ä¸å­˜åœ¨å¯¹åº”çš„DOMï¼Œå› ä¸ºReact appæ¸²æŸ“æ˜¯ä¾èµ–ä¸€ä¸ªå·²æœ‰çš„htmlæ–‡ä»¶çš„ï¼ˆæ¯”å¦‚htmlä¸­æœ‰ä¸€ä¸ªidä¸º`root`çš„divï¼Œæˆ‘ä»¬çš„appä¼šæ¸²æŸ“åˆ°è¿™ä¸ªdivä¸Šï¼‰ï¼Œè€Œç°åœ¨æˆ‘ä»¬æµ‹è¯•çš„ä»£ç æ˜¯ä»å®Œå…¨ç©ºç™½çš„é¡µé¢å¼€å§‹çš„ã€‚OKï¼Œé‚£ä¹ˆå…ˆç ”ç©¶ä¸‹`create-react-app`æ˜¯æ€ä¹ˆæŠŠä¸¤è€…å…³è”èµ·æ¥çš„ï¼š

é¦–å…ˆï¼Œåœ¨æ‰§è¡Œ`npm start`çš„æ—¶å€™ï¼Œ`create-react-app`ä¼šå…ˆä½¿ç”¨webpackæ¥å°†æ‰€æœ‰ä¾èµ–çš„ä»£ç æ‰“åŒ…åˆ°ä¸€ä¸ªjsæ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥æ— è®ºä½ çš„Reactæ¸²æŸ“çš„ä»£ç å†™åœ¨å“ªé‡Œï¼Œæœ€åæ‰§è¡Œäº†æ‰“åŒ…å¥½çš„jsæ–‡ä»¶ä¹Ÿå°±æ‰§è¡Œäº†æ¸²æŸ“çš„ä»£ç ã€‚

å…¶æ¬¡ï¼Œåœ¨æ‰“åŒ…å¥½jsæ–‡ä»¶ä¹‹åï¼Œ`create-react-app`ä¼šå¯åŠ¨ä¸€ä¸ªweb serveræ¥hostæ‰€æœ‰çš„èµ„æºï¼Œå…¶ä¸­å®ƒå†™æ­»äº†åªæœ‰åœ¨`public`æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ä¼šè¢«å½“åšèµ„æºåŠ è½½åˆ°serverä¸Šï¼Œå› æ­¤åœ¨è¿™ä¸ªweb serverä¸Šï¼Œæˆ‘ä»¬ä¼šæ‰“å¼€`public/index.html`é¡µé¢ï¼Œå¹¶åœ¨ä¸Šé¢è¿è¡Œæˆ‘ä»¬çš„æ¸²æŸ“React appçš„jsä»£ç ã€‚

------

ä»¥ä¸Šï¼Œä¸ºäº†é¿å…ä¸€å¼€å§‹å‡ºç°çš„é”™è¯¯ï¼Œè¦ä¹ˆå°±åƒä¸‹é¢çš„ä»£ç é‚£æ ·äººä¸ºåˆ›å»ºä¸€ä¸ªDOMå†æ‰§è¡Œæ¸²æŸ“ï¼Œè¦ä¹ˆå°±ä¹ŸæŠŠä¹‹å‰çš„htmlæ–‡ä»¶åŠ è½½åˆ°æµ‹è¯•çš„serverä¸Šï¼ˆå¦‚æœç”¨Karmaçš„è¯ï¼Œå¯ä»¥ç”¨[html2js preprocessor](https://github.com/karma-runner/karma-html2js-preprocessor)æ¥æŠŠhtmlæ–‡ä»¶åƒjsä¸€æ ·åŠ è½½è¿›æ¥ï¼‰ã€‚

```javascript
import {expect} from "chai";
import React from 'react';
import ReactDOM from 'react-dom';
import App from '../src/App';

describe("app", () => {
    it("loads without problems", () => {
        const div = document.createElement('div');
        document.body.appendChild(div);
        ReactDOM.render(<App />, div);
    });
});
```

### Test React app with Karma###

å’ŒBabeléœ€è¦å†™ä¸€ä¸ª`.babelrc`é…ç½®æ–‡ä»¶ç±»ä¼¼ï¼ŒKarmaä¹Ÿéœ€è¦å†™ä¸€ä¸ª`karma.conf.js`ä½œä¸ºå®ƒçš„é…ç½®æ–‡ä»¶ã€‚å…·ä½“æ€ä¹ˆå†™è¿™ä¸ªé…ç½®æ–‡ä»¶è¿™é‡Œä¸å¤šè®²ï¼Œå»ºè®®å‚è€ƒ[react-karma-webpack-testing](https://github.com/justinwoo/react-karma-webpack-testing)è¿™ä¸ªé¡¹ç›®ã€‚

è¿™é‡Œæå‡ ä¸ªç¢°åˆ°çš„å‘ï¼š

- å¦‚æœé¡¹ç›®ç”¨åˆ°äº†`react-router`ï¼ŒKarmaæµ‹è¯•é»˜è®¤æ‰“å¼€çš„é¡µé¢è·¯å¾„æ˜¯`/debug.html`ï¼Œä¸æ˜¯`/`å“¦ï¼Œè¿™é‡Œå¯èƒ½ä¼šæœ‰é—®é¢˜ï¼›
- å¦‚æœæ²¡æœ‰host `public/index.html`æ–‡ä»¶ï¼Œé¡¹ç›®çš„å…¥å£å‡½æ•°æ‰€åœ¨çš„jsæ–‡ä»¶å°±ä¸è¦åŠ è½½åˆ°Karmaçš„serverä¸Šï¼›